<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>GraphQL Mobile</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/xebia.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>
<body>
<div class="reveal">
    <div class="slides">
        <header>
            <img class="brand-logo" src="asset/xebia-logo.svg">
        </header>
        <section>
            <h1>GraphQL on mobile side</h1>
        </section>
        <section>
            <h2>Agenda</h2>
            <ul>
                <li>One more feature</li>
                <li>Client</li>
                <li>Vanilla</li>
                <li>Minimal library</li>
                <li>Generate code from query</li>
            </ul>
        </section>
        <section>
            <section>
                <h3>One more feature</h3>
                <h4>Fragments</h4>
            </section>
            <section>
                <p>Fragments define pieces that can be used in <em>multiple</em> places</p>
            </section>
            <section>
                <p>How to avoid repetitions?</p>
                <pre><code data-trim data-noescape>
                    query PersonAndFriends {
                        person(personID: "6") {
                            name
                            height
                            mass
                            birthYear
                            eyeColor

                            friends {
                                name
                                height
                                mass
                                birthYear
                                eyeColor
                            }
                        }
                    }
                </code></pre>
            </section>

            <section>
                <pre><code data-trim data-noescape>
                    fragment PersonDetails on Person {
                        name
                        height
                        mass
                        birthYear
                        eyeColor
                    }
                </code></pre>

                <pre><code data-trim data-noescape>
                    query PersonAndFriends {
                        person(personID: "6") {
                            ...PersonDetails
                            
                            friends {
                                ...PersonDetails
                            }
                        }
                    }
                </code></pre>
            </section>
        </section>
        <section>
            <section>
                <h3>Can I use <code>Swagger</code>?</h3>
            </section>
            <section data-background-image="https://media.giphy.com/media/3o7btT1T9qpQZWhNlK/giphy.gif"></section>
            <section>
                <h3>GraphiQL</h3>
                <blockquote>
                    A graphical interface in-browser GraphQL&nbsp;IDE
                </blockquote>
            </section>
            <section data-background-image="https://i.imgur.com/sc6lHI4.png"></section>
            <section>
                <h4>How?</h4>
                <pre><code data-trim data-noescape>
                    use express-graphql
                </code></pre>
                or
                <pre><code data-trim data-noescape>
                    npm i -g graphiql
                </code></pre>
                or
                <pre><code data-trim data-noescape>
                    brew cask install graphiql
                </code></pre>
            </section>
        </section>
        <section>
            <section>
                <h3>What can we do with vanilla code?</h3>
            </section>
            <section>
                <h3>Not much actually...</h3>
            </section>
            <section>
                <h3>Example using Fake GraphQL API</h3>
                <pre><code data-trim data-noescape>
                    http://fake.graphql.guru/graphql/
                </code></pre>
            </section>
            <section>
                <h3>Query</h3>
                <pre><code data-trim data-noescape>
                    {
                      Fake {
                        id
                        firstName
                        lastName
                      }
                    }
                </code></pre>
            </section>
            <section>
                <h3>Response</h3>
                <pre><code data-trim data-noescape>
                    {
                      "data": {
                        "Fake": {
                          "id": "c2c2681b-ed9e-42d1-9c3d-228c8d89630d",
                          "firstName": "Dessie",
                          "lastName": "Cremin"
                        }
                      }
                    }
                </code></pre>
            </section>
            <section>
                <h3>Android</h3>
                <pre><code data-trim data-noescape>
                    val request = Request.Builder()
                        .url("http://fake.graphql.guru/graphql/")
                        .post(RequestBody.create(JSON,
                            "{\"query\":\"{Fake{id,firstName,lastName}}\"}"))
                        .build()
                </code></pre>
                <pre><code data-trim data-noescape>
                    val str = response.body()?.string()
                    if (str != null)
                        val fake: Fake? = userAdapter
                            .fromJson(JSONObject(str)
                            .getJSONObject("data")
                            .getString("Fake"))
                </code></pre>
            </section>
            <section>
                <h3>Take away</h3>
                <ol>
                    <li>Lot of boiler plate</li>
                    <li>Not statically typed</li>
                    <li>Hard to maintain</li>
                </ol>
            </section>
        </section>
        <section>
            <section>
                <h3>Any <code>small</code> Android library out here?</h3>
            </section>
            <section>
                <h3>Kraph</h3>
                <h4>JSON request body builder written in Kotlin</h4>
            </section>
            <section>
                <h4>Create a query with Kraph DSL</h4>
                <pre><code data-trim data-noescape>
                    Kraph {
                      query {
                        fieldObject("Fake") {
                          field("id")
                          field("firstName")
                          field("lastName")
                        }
                      }
                    }.toRequestString()
                </code></pre>
            </section>
            <section>
                <h4>Query generated</h4>
                <pre><code data-trim data-noescape>
                    {"query": "query { Fake { id firstName lastName } }",
                        "variables": null, "operationName": null}
                </code></pre>
            </section>
            <section>
                <h4><code>toGraphQueryString()</code> to generate pretty query</h4>
                <pre><code data-trim data-noescape>
                    query {
                      Fake {
                        id
                        firstName
                        lastName
                      }
                    }
                </code></pre>
            </section>
            <section>
                <h4>Features</h4>
                <ol>
                    <li>Query and Mutation</li>
                    <li>Fragment (re-usable Kraph query)</li>
                    <li>Support for Relay Mutation (<a href="https://facebook.github.io/relay/graphql/mutations.htm">Relay
                        Input Object Mutation</a>)
                    </li>
                    <li>Support for Relay Cursor Connection (<a
                            href="https://facebook.github.io/relay/graphql/connections.htm">Relay Cursor Connection</a>)
                    </li>
                </ol>
            </section>
            <section>
                <h3>Take away</h3>
                <ol>
                    <li>Fast and maintainable way to define query</li>
                    <li>More expressive but less concise</li>
                    <li>Quite easy to maintain</li>
                </ol>
            </section>
        </section>
        <section>
            <section>
                <h3>Any <code>small</code> <span style="text-transform: lowercase;">i</span>OS library out here?</h3>
            </section>
            <section>
                <ul>
                    <li>https://github.com/WeltN24/GraphQLicious</li>
                    <li>https://github.com/JanGorman/Chester</li>
                    <li>https://github.com/LeToteTeam/Stardaze</li>
                    <li>https://github.com/Anobisoft/ASGraphQLClient
                        <small>(Objective-C)</small>
                    </li>
                </ul>
            </section>
            <section>
                <h3>Chester Code Example</h3>
                <pre><code data-trim data-noescape>
                    import Chester

                    let query = QueryBuilder()
                        .from("posts")
                        .with(arguments: Argument(key: "id", value: "20"), Argument(key: "author", value: "Chester"))
                        .with(fields: "id", "title", "content")

                    let queryString = try? query.build
                </code></pre>
            </section>
        </section>
        <section>
            <section>
                <h3>Any lib to generate typed code from query string?</h3>
            </section>
            <section
                    data-background-image="https://media1.tenor.com/images/0d051bc256ec40e7ac80e3fd56ed9390/tenor.gif?itemid=4349636">
            </section>
            <section>
                <img style="padding-left: 40px"
                     data-src="https://cdn-images-1.medium.com/max/506/1*ii79rz_-iauM21n4L3g9Ug@2x.png" alt="" src="">
            </section>
            <section>
                <h4>Write queries, not code.</h4>
            </section>
            <section>
                <h4>Android: setup</h4>
                <p>Add dependencies</p>
                <pre><code data-trim data-noescape>
                    apply plugin: 'com.apollographql.android'

                    buildscript {
                        ext.apollo_version = '0.4.3'
                        dependencies {
                            classpath "com.apollographql.apollo:apollo-gradle-plugin:$apollo_version"
                        }
                    }

                    dependencies {
                        implementation "com.apollographql.apollo:apollo-runtime:$apollo_version"
                        implementation "com.apollographql.apollo:apollo-android-support:$apollo_version"
                    }
                </code></pre>
            </section>
            <section>
                <h4>Android: how to?</h4>
                <p>Query</p>
                <ol>
                    <li>Store queries in <code>src/main/graphql/**/*.graphql</code></li>
                    <li>Use <code>apollo-codegen</code> to download schema</li>
                </ol>
            </section>
            <section>
                <h4>Android: how to?</h4>
                <p>Query</p>
                <pre><code data-trim data-noescape>
                    query GetUser {
                        Fake {
                            id
                            firstName
                            lastName
                        }
                    }
                </code></pre>
            </section>
            <section>
                <h4>Android: how to?</h4>
                <p>Build</p>
                <pre><code data-trim data-noescape>
                    companion object {
                        const val URL = "http://fake.graphql.guru/graphql/"
                        val CLIENT = OkHttpClient()
                        private val APOLLO = ApolloClient.builder().serverUrl(URL).okHttpClient(CLIENT).build()
                    }
                </code></pre>
            </section>
            <section>
                <h4>Android: how to?</h4>
                <p>Build</p>
                <pre><code data-trim data-noescape>
                APOLLO.query(GetUserQuery.builder().build())
                    .enqueue(object : Callback<GetUserQuery.Data>() {
                        override fun onFailure(ignored: ApolloException) {}

                        override fun onResponse(response: Response<GetUserQuery.Data>) {
                            idApolloView.text =
                                response.data()?.Fake()?.id()
                            firstNameApolloView.text =
                                response.data()?.Fake()?.firstName()
                            lastNameApolloView.text =
                                response.data()?.Fake()?.lastName()
                        }
                    })
                </code></pre>
            </section>
            <section data-background-image="https://media.giphy.com/media/l3vQY4uui06iabkli/giphy.gif">
            </section>
            <section>
                <h3>Take away</h3>
                <ul>
                    <li>All queries in one place (folder)</li>
                    <li>Auto-generated query at compile time</li>
                    <li>Written in Java generating Java code</li>
                    <li>Type safe</li>
                </ul>
            </section>
            <section>
                <h3>Bonus</h3>
                <ul>
                    <li>Custom scalar types</li>
                    <li>Cached response support</li>
                    <li>RxJava support</li>
                </ul>
            </section>
        </section>
        <section>
            <section>
                <h3><span style="text-transform: lowercase">i</span>OS: How to?</h3>
                <ol>
                    <li class="fragment">Install the Apollo framework into your project and link it to your application target</li>
                    <li class="fragment">Install <code>apollo-codegen</code> globally through <code>npm</code></li>
                    <li class="fragment">Add a schema file to your target directory</li>
                    <li class="fragment">Add a code generation build phase to your target</li>
                    <li class="fragment">Build your target</li>
                    <li class="fragment">Add the generated API file to your target</li>
                    <li class="fragment">Create <code>.graphql</code> files with your queries or mutations and add them to your target</li>
                </ol>
            </section>
            <section>
                <ol>
                    <li>Install Apollo Library</li>
                </ol>
                <pre><code data-trim data-noescape>
                    pod 'Apollo', '~> 0.7.0'
                    github "apollographql/apollo-ios" "0.7.0"
                </code></pre>
                <ol start="2">
                    <li>Install Apollo Codegen</li>
                </ol>
                <pre><code data-trim data-noescape>
                    npm install -g apollo-codegen
                </code></pre>
            </section>
            <section>
                <ol start="3">
                    <li>Download the schema</li>
                </ol>
                <pre><code data-trim data-noescape>
                    apollo-codegen download-schema http://HOST:PORT/graphql --output schema.json
                </code></pre>
                <ol start="4">
                    <li>Add Build Phase</li>
                </ol>
                <pre><code data-trim data-noescape>
                    APOLLO_FRAMEWORK_PATH="$(eval find $FRAMEWORK_SEARCH_PATHS -name "Apollo.framework" -maxdepth 1)"

                    if [ -z "$APOLLO_FRAMEWORK_PATH" ]; then
                        echo "error: Couldn't find Apollo.framework in FRAMEWORK_SEARCH_PATHS;"
                        exit 1
                    fi

                    cd "${SRCROOT}/${TARGET_NAME}"
                    $APOLLO_FRAMEWORK_PATH/check-and-run-apollo-codegen.sh generate $(find . -name '*.graphql') --schema schema.json --output API.swift
                </code></pre>
            </section>
            <section>
                <ol start="5">
                    <li>Build</li>
                    <li>Add the generated file (<code>API.swift</code>)</li>
                    <li>Add <code>.graphql</code> files and rebuild</li>
                </ol>
            </section>
        </section>
        <section>
            <section>
                <h3>Running a query on <span style="text-transform: lowercase;">i</span>OS</h3>
            </section>
            <section>
                <ol>
                    <li>Create a new .graphql file in your project, for instance Revenge.graphql</li>
                    <pre><code data-trim data-noescape>
                        query Revenge {
                            film(filmID: "6") {
                                releaseDate
                            }
                        }
                    </code></pre>

                    <li>Run the compiler</li>
                    <li>Swift code for the query will be generated and added to <code>API.swift</code></li>
                </ol>
            </section>
            <section>
                <ol start="4">
                    <li>Create a new <code>ApolloClient</code> instance</li>
                    <pre><code data-trim data-noescape>
                        let client = ApolloClient(url: "MY_URL")
                    </code></pre>
                </ol>
            </section>
            <section>
                <ol start="5">
                    <li>Pass a Query object to the client's <code>fetch</code> method</li>
                    <pre><code data-trim data-noescape>
                        client.fetch(query: RevengeQuery()) { result, error in
                            guard let result = result else {
                                // Do something with 'error'
                                return
                            }
                            // 'result' contains your query output
                        }
                    </code></pre>
                </ol>
            </section>
        </section>
        <section>
            <section>
                <h3>Main advantages</h3>
                <ul>
                    <li>Code generation (works offline)</li>
                    <li>GraphiQL:</li>
                    <ul>
                        <li>Try your query</li>
                        <li>Documentation</li>
                    </ul>
                    <li>Fragments</li>
                    <li>Plays well with Swift's strong typing (sort of)</li>
                </ul>
            </section>
            <section>
                <h3>Main issues</h3>
                <ul>
                    <li>Uploading</li>
                    <li>Optional-by-default</li>
                    <li>Type conformance</li>
                </ul>
            </section>
            <section>
                <h4>Type Conformance</h4>
            </section>
                <section>
                    <p>Let's say we need to write the following:</p>
                    <pre><code data-trim data-noescape>
                        func displayHeroName(hero: Hero) {
                            myLabel.text = hero.name
                        }
                    </code></pre>

                    <p>We'd like the <code>Hero</code> type to be provided by a number of <em>different</em> sources.</p>
                </section>
                <section>
                    <p>For instance:</p>
                    <pre><code data-trim data-noescape>
                        query Vader {
                            person(id: "cGVvcGxlOjQ=") {
                                name
                            }
                        }
                    </code></pre>

                    <hr>

                    <pre><code data-trim data-noescape>
                        query Revenge {
                            film(filmID: "6") {
                                characterConnection(first: 5) {
                                    characters {
                                        name
                                    }
                                }
                            }
                        }
                    </code></pre>

                    <hr>

                    <p>Are the results compatible with each other?</p>
                </section>

                <section>
                    <h4>Nope.</h4>                    
                </section>

                <section>
                    <pre><code data-trim data-noescape>
                        query Vader {
                            person(id: "cGVvcGxlOjQ=") {
                                name
                            }
                        }
                    </code></pre>
                    <pre><code>-> VaderQuery.Data.Person</code></pre>

                    <hr>
                    
                    <pre><code data-trim data-noescape>
                        query Revenge {
                            film(filmID: "6") {
                                characterConnection(first: 5) {
                                    characters {
                                        name
                                    }
                                }
                            }
                        }
                    </code></pre>
                    <pre><code>-> RevengeQuery.Data.Film.CharacterConnection.Character</code></pre>
                </section>

                <section>
                    <h4>Two solutions:</h4>
                    <ol>
                        <li>Swift protocols</li>
                        <pre><code data-trim data-noescape>
                            protocol Hero {
                                var name: String { get }
                            }

                            extension VaderQuery.Data.Person: Hero { }
                            extension eQuery.Data.Film.CharacterConnection.Character: Hero { }
                        </code></pre>
                    </ol>
                </section>
                <section>
                    <ol start="2">
                        <li>Fragments</li>
                        <pre><code data-trim data-noescape>
                            query Vader {
                                person(id: "cGVvcGxlOjQ=") {
                                    ...PersonDetail
                                }
                            }
                        </code></pre>

                        <pre><code data-trim data-noescape>
                            query Revenge {
                                film(filmID: "6") {
                                    releaseDate
                                    characterConnection(first: 5) {
                                        characters {
                                            ...PersonDetail
                                        }
                                    }
                                }
                            }
                        </code></pre>
                    </ol>
                </section>

                <section>
                    <h4>Optional-by-default</h4>
                    <ul>
                        <li>GraphQL object fields are optional by default</li>
                        <li>Non-optionality can be enforced using "<code>!</code>"</li>
                        <li>Having non-optional values missing from a query will result in an error</li>
                        <li>Use optionality only when strictly needed</li>
                    </ul>
                </section>
            </section>
        </section>
        <section>
            <h3>Thank you!</h3>
            <blockquote>
                http://github.com/xebia-france/talk-graphql-mobile
            </blockquote>
            <blockquote>
                http://xebia-france.github.io/talk-graphql-mobile
            </blockquote>
        </section>
        <footer>
            <span class="footer-left">Simone <a href="https://twitter.com/viteinfinite">@viteinfinite</a></span>
            <span class="footer-right">Benjamin <a href="https://twitter.com/benjlacroix">@benjlacroix</a></span>
        </footer>
    </div>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>
    Reveal.initialize({
        slideNumber: true,
        history: true,
        dependencies: [
            {src: 'plugin/markdown/marked.js'},
            {src: 'plugin/markdown/markdown.js'},
            {src: 'plugin/notes/notes.js', async: true},
            {
                src: 'plugin/highlight/highlight.js', async: true, callback: function () {
                    hljs.initHighlightingOnLoad();
                },
            }]
    });
</script>
</body>
</html>
